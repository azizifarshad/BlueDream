@model BlueDream.Models.ViewModels.BookingViewModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<div class="container my-5">
    <form id="bookingForm" method="post" asp-action="Calendar">
        <div class="accordion" id="categoryAccordion">
            @foreach (var category in Model.Categories)
            {
            var catId = $"cat_{category.Id}";
            <div class="accordion-item border-0 mb-4">
                <h2 class="accordion-header" id="heading_@catId">
                    <button class="accordion-button collapsed category-header"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse_@catId"
                            aria-expanded="false"
                            aria-controls="collapse_@catId">
                        @category.Name
                    </button>
                </h2>

                <div id="collapse_@catId"
                     class="accordion-collapse collapse"
                     aria-labelledby="heading_@catId"
                     data-bs-parent="#categoryAccordion">
                    <div class="accordion-body">
                        <div class="accordion" id="groupAccordion_@catId">
                            @foreach (var group in category.ItemGroups)
                            {
                            var groupId = $"grp_{group.Id}";
                            <div class="accordion-item border-0 mb-3 shadow-sm">
                                <h2 class="accordion-header" id="heading_@groupId">
                                    <button class="accordion-button collapsed bg-white"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapse_@groupId"
                                            aria-expanded="false"
                                            aria-controls="collapse_@groupId">
                                        <div>
                                            <div class="group-title">@group.Name</div>
                                            <span class="show-details" onclick="openDetails('@group.Name','@group.Description')">Show Details</span>
                                        </div>
                                    </button>
                                </h2>

                                <div id="collapse_@groupId"
                                     class="accordion-collapse collapse"
                                     aria-labelledby="heading_@groupId"
                                     data-bs-parent="#groupAccordion_@catId">
                                    <div class="accordion-body">
                                        @if (group.Items?.Any() == true)
                                        {
                                        <ul class="list-group list-group-flush">
                                            @foreach (var item in group.Items)
                                            {
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="item-name">@item.Name</div>
                                                    @if (!string.IsNullOrEmpty(item.Description))
                                                    { <div class="item-description">@item.Description</div> }
                                                    <div class="item-time">⏱ @item.TimeSpend min</div>
                                                </div>
                                                <div class="text-end">
                                                    <div class="item-price">
                                                        @if(item.Discount > 0)
                                                        {
                                                        <span class="text-decoration-line-through text-muted me-2">€@item.Price</span>
                                                        <span class="fw-bold text-success">€@(item.Price - (item.Price * item.Discount / 100))</span>
                                                        }
                                                        else { @( "€" + item.Price ) }
                                                    </div>
                                                    <button type="button"
                                                            class="select-btn mt-2 @(HttpContextAccessor.HttpContext.Session.GetString("SelectedItems")?.Split(',').Contains(item.Id.ToString()) == true ? "active" : "")"
                                                            data-itemid="@item.Id">
                                                        Select
                                                    </button>
                                                </div>
                                            </li>
                                            }
                                        </ul>
                                        }
                                        else { <p class="text-muted fst-italic">No items in this group.</p> }
                                    </div>
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
            }
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-next btn-lg px-5">Next →</button>
        </div>
    </form>
</div>

<!-- MODAL -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background:#F6F1EB; border-radius:14px;">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="detailsTitle" style="color:#1A2A6C;"></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsText" style="font-size:1rem; color:#444;"></div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function openDetails(title, text) {
        $("#detailsTitle").text(title);
        $("#detailsText").text(text);
        new bootstrap.Modal(document.getElementById('detailsModal')).show();
    }
</script>
}
