@model BlueDream.Models.ViewModels.BookingViewModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<div class="container my-5">
    <form id="bookingForm" method="post" asp-action="Calendar">
        <div class="accordion" id="categoryAccordion">
            @foreach (var category in Model.Categories)
            {
                var catId = $"cat_{category.Id}";
                <div class="accordion-item border-0 mb-4">
                    <h2 class="accordion-header" id="heading_@catId">
                        <button class="accordion-button collapsed category-header"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapse_@catId"
                                aria-expanded="false"
                                aria-controls="collapse_@catId">
                            @category.Name
                        </button>
                    </h2>

                    <div id="collapse_@catId"
                         class="accordion-collapse collapse"
                         aria-labelledby="heading_@catId"
                         data-bs-parent="#categoryAccordion">
                        <div class="accordion-body">
                            <div class="accordion" id="groupAccordion_@catId">
                                @foreach (var group in category.ItemGroups)
                                {
                                    var groupId = $"grp_{group.Id}";
                                    <div class="accordion-item border-0 mb-3 shadow-sm">
                                        <h2 class="accordion-header" id="heading_@groupId">
                                            <button class="accordion-button collapsed bg-white group-header"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#collapse_@groupId"
                                                    aria-expanded="false"
                                                    aria-controls="collapse_@groupId">
                                                <div>
                                                    <div class="group-title">@group.Name</div>
                                                    <div class="show-details" onclick="openDetails('@group.Name','@group.Description')">Show Details</div>
                                                </div>
                                            </button>
                                        </h2>

                                        <div id="collapse_@groupId"
                                             class="accordion-collapse collapse"
                                             aria-labelledby="heading_@groupId"
                                             data-bs-parent="#groupAccordion_@catId">
                                            <div class="accordion-body">
                                                @if (group.Items?.Any() == true)
                                                {
                                                    <ul class="list-group list-group-flush">
                                                        @foreach (var item in group.Items)
                                                        {
                                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <div class="item-name">@item.Name</div>
                                                                    @if (!string.IsNullOrEmpty(item.Description))
                                                                    { <div class="item-description">@item.Description</div> }
                                                                    <div class="item-time">⏱ @item.TimeSpend min</div>
                                                                </div>
                                                                <div class="text-end">
                                                                    <div class="item-price">
                                                                        @if(item.Discount > 0)
                                                                        {
                                                                            <span class="text-decoration-line-through text-muted me-2">€@item.Price</span>
                                                                            <span class="fw-bold text-success">€@(item.Price - (item.Price * item.Discount / 100))</span>
                                                                        }
                                                                        else { <span class="fw-bold">€@item.Price</span> }
                                                                    </div>
                                                                    <button type="button"
                                                                            class="select-btn mt-2 @(HttpContextAccessor.HttpContext.Session.GetString("SelectedItems")?.Split(',').Contains(item.Id.ToString()) == true ? "active" : "")"
                                                                            data-itemid="@item.Id"
                                                                            data-groupid="@group.Id">
                                                                        Select
                                                                    </button>
                                                                </div>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else { <p class="text-muted fst-italic">No items in this group.</p> }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-next btn-lg px-5">Next →</button>
        </div>
    </form>
</div>

<!-- MODAL DETAILS -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background:#F6F1EB; border-radius:14px;">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="detailsTitle" style="color:#1A2A6C;"></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsText" style="font-size:1rem; color:#444;"></div>
        </div>
    </div>
</div>

<!-- MODAL LOGIN -->
<div class="modal fade" id="loginPromptModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Login Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Please login first to select an item.</p>
                <a href="/Account/Login?returnUrl=@Url.Action("Index","Booking")" class="btn btn-primary w-100">Go to Login</a>
            </div>
        </div>
    </div>
</div>

<style>
/* ---------- CATEGORY STYLING ---------- */
.category-header { font-size: 1.6rem; font-weight: 700; color: #1A2A6C !important; }
/* ---------- GROUP STYLING ---------- */
.group-header { font-size: 1.2rem; font-weight: 600; color: #000; }
.group-header .show-details { font-size: 0.85rem; color: #000; cursor: pointer; transition: color 0.2s; }
.group-header .show-details:hover { color: #1A2A6C; }
/* ---------- ITEM STYLING ---------- */
.item-name { font-size: 1rem; font-weight: 600; }
.item-description { font-size: 0.9rem; color: #333; }
.item-time { font-size: 1.05rem; font-weight: 500; margin-top: 3px; }
.item-price { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
/* ---------- SELECT BUTTON ---------- */
.select-btn { border:1px solid #1A2A6C; padding:6px 16px; border-radius:8px; font-size:1rem; cursor:pointer; font-weight:600; transition:0.2s; background:#fff; color:#1A2A6C; }
.select-btn.active { background:#E6BE8A; color:#1A2A6C; }
.select-btn:hover { background:#E6BE8A; color:#1A2A6C; }
/* ---------- NEXT BUTTON ---------- */
.btn-next { background-color: #1A2A6C; color: #fff; font-size: 1.1rem; font-weight: 600; transition: 0.2s; }
.btn-next:hover { background-color: #E6BE8A; color: #1A2A6C; }
</style>

@section Scripts {
<script>
function openDetails(title, text) {
    $("#detailsTitle").text(title);
    $("#detailsText").text(text);
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

$(document).ready(function () {
    // ---------- MiniCart Update ----------
    function updateMiniCart() {
        $.getJSON('@Url.Action("GetCartItems","Booking")', function (data) {
            var badge = $('#cartDropdown .badge-cart');
            var dropdown = $('#cartDropdown + .dropdown-menu');
            dropdown.empty();
            if (data.itemCount > 0) {
                badge.text(data.itemCount).show();
                $.each(data.items, function (i, item) {
                    dropdown.append('<li class="cart-item d-flex justify-content-between align-items-center px-2 py-1" data-itemid="' + item.Id + '">' +
                        '<span>' + item.Name + '</span>' +
                        '<span>€' + parseFloat(item.Price).toFixed(2) + '</span></li>');
                });
                dropdown.append('<li><hr class="dropdown-divider"/></li>');
                dropdown.append('<li class="px-2"><strong>Total: €' + parseFloat(data.total).toFixed(2) + '</strong></li>');
                dropdown.append('<li class="px-2 mt-2"><a class="btn btn-primary w-100" href="@Url.Action("Calendar","Booking")">Go to Checkout</a></li>');
            } else {
                badge.hide();
                dropdown.append('<li class="px-2 text-muted">Your cart is empty</li>');
            }
        });
    }

    // ---------- Select Button Logic ----------
    $(document).on("click", ".select-btn", function () {
        var btn = $(this);
        var itemId = btn.data("itemid");
        var groupId = btn.data("groupid");

        var isAuthenticated = @User.Identity.IsAuthenticated.ToString().ToLower();
        if (!isAuthenticated) {
            new bootstrap.Modal(document.getElementById('loginPromptModal')).show();
            return; 
        }

        // Radio-like toggle
        $('.select-btn[data-groupid="' + groupId + '"]').removeClass('active');
        btn.addClass('active');

        $.post('@Url.Action("ToggleCartItem","Booking")', { itemId: itemId }, function () {
            updateMiniCart();
        });
    });

    // ---------- Next Button Validation ----------
    $("#bookingForm").on("submit", function(e){
        var selected = $(".select-btn.active").length;
        if(selected === 0){
            e.preventDefault();
            alert("Please select at least one item before proceeding.");
        }
    });

    updateMiniCart();
});
</script>
}
