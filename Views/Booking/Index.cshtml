@model BlueDream.Models.ViewModels.BookingViewModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Book Your Service";
}

<style>
    /* ------------------ GLOBAL ------------------ */
    body {
        font-family: 'Inter', sans-serif;
    }

    .category-header {
        background: #ffffff !important;
        border-bottom: 2px solid #eee;
        font-size: 1.4rem;
        padding: 18px;
        color: #1A2A6C; /* Navy Blue */
        font-weight: 700;
    }

    .accordion-button:not(.collapsed) {
        background: #fff !important;
        color: #000 !important;
        box-shadow: none !important;
    }

    .accordion-button:focus {
        border: none !important;
        box-shadow: none !important;
    }

    /* ------------------ GROUP ITEMS ------------------ */
    .group-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1b1b1b;
    }

    .show-details {
        margin-top: 4px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        color: #555;
        border-bottom: 1px solid #aaa;
        display: inline-block;
        text-transform: capitalize; /* Pascal Case */
    }

    .show-details:hover {
        color: #1A2A6C; /* Navy Blue on hover */
    }

    /* ------------------ ITEMS ------------------ */
    .item-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #222;
    }

    .item-description {
        font-size: 1rem;
        color: #666;
    }

    .item-time {
        font-size: 1rem; /* slightly larger */
        color: #1A2A6C; /* Navy Blue */
        font-weight: 600;
    }

    .item-price {
        font-size: 1.2rem;
        font-weight: 700;
        margin-top: 4px;
    }

    .select-btn {
        border: 1px solid #1A2A6C;
        padding: 6px 16px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        font-weight: 600;
        transition: 0.2s;
        background: #fff;
        color: #1A2A6C;
    }

    .select-btn.active {
        background: #E6BE8A; /* Champagne Gold */
        color: #1A2A6C; 
    }

    .select-btn:hover {
        background: #E6BE8A; /* Champagne Gold on hover */
        color: #1A2A6C;
    }

    .btn-next {
        background: #1A2A6C;
        color: #fff;
        transition: 0.2s;
    }

    .btn-next:hover {
        background: #E6BE8A;
        color: #1A2A6C;
    }

</style>

<div class="container my-5">
    <form id="bookingForm" method="post" asp-action="Calendar">

        <div class="accordion" id="categoryAccordion">
            @foreach (var category in Model.Categories)
            {
                var catId = $"cat_{category.Id}";
                <div class="accordion-item border-0 mb-4">

                    <h2 class="accordion-header" id="heading_@catId">
                        <button class="accordion-button collapsed category-header"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapse_@catId"
                                aria-expanded="false"
                                aria-controls="collapse_@catId">
                            @category.Name
                        </button>
                    </h2>

                    <div id="collapse_@catId"
                         class="accordion-collapse collapse"
                         aria-labelledby="heading_@catId"
                         data-bs-parent="#categoryAccordion">

                        <div class="accordion-body">

                            <div class="accordion" id="groupAccordion_@catId">

                                @foreach (var group in category.ItemGroups)
                                {
                                    var groupId = $"grp_{group.Id}";
                                    <div class="accordion-item border-0 mb-3 shadow-sm">

                                        <h2 class="accordion-header" id="heading_@groupId">
                                            <button class="accordion-button collapsed bg-white"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#collapse_@groupId"
                                                    aria-expanded="false"
                                                    aria-controls="collapse_@groupId">

                                                <div>
                                                    <div class="group-title">@group.Name</div>
                                                    <span class="show-details" onclick="openDetails('@group.Name','@group.Description')">
                                                        Show Details
                                                    </span>
                                                </div>
                                            </button>
                                        </h2>

                                        <div id="collapse_@groupId"
                                             class="accordion-collapse collapse"
                                             aria-labelledby="heading_@groupId"
                                             data-bs-parent="#groupAccordion_@catId">

                                            <div class="accordion-body">

                                                @if (group.Items?.Any() == true)
                                                {
                                                    <ul class="list-group list-group-flush">

                                                        @foreach (var item in group.Items)
                                                        {
                                                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                                                <div>
                                                                    <div class="item-name">@item.Name</div>

                                                                    @if (!string.IsNullOrEmpty(item.Description))
                                                                    {
                                                                        <div class="item-description">@item.Description</div>
                                                                    }

                                                                    <div class="item-time">⏱ @item.TimeSpend min</div>
                                                                </div>

                                                                <div class="text-end">

                                                                    <div class="item-price">
                                                                        @if(item.Discount > 0)
                                                                        {
                                                                            <span class="text-decoration-line-through text-muted me-2">€@item.Price</span>
                                                                            <span class="fw-bold text-success">€@(item.Price - (item.Price * item.Discount / 100))</span>
                                                                        }
                                                                        else
                                                                        {
                                                                            @( "€" + item.Price )
                                                                        }
                                                                    </div>

                                                                    <button type="button"
                                                                            class="select-btn mt-2 @(HttpContextAccessor.HttpContext.Session.GetString("SelectedItems")?.Split(',').Contains(item.Id.ToString()) == true ? "active" : "")"
                                                                            data-itemid="@item.Id">
                                                                        Select
                                                                    </button>
                                                                </div>

                                                            </li>
                                                        }

                                                    </ul>
                                                }
                                                else
                                                {
                                                    <p class="text-muted fst-italic">No items in this group.</p>
                                                }

                                            </div>
                                        </div>

                                    </div>
                                }

                            </div>

                        </div>
                    </div>

                </div>
            }
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-next btn-lg px-5">Next →</button>
        </div>

    </form>
</div>

<!-- ---------------- MODAL ---------------- -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background:#F6F1EB; border-radius:14px;">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="detailsTitle" style="color:#1A2A6C;"></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsText" style="font-size:1rem; color:#444;"></div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>

<script>
    function openDetails(title, text) {
        $("#detailsTitle").text(title);
        $("#detailsText").text(text);
        new bootstrap.Modal(document.getElementById('detailsModal')).show();
    }

    // SELECT BUTTON - RADIO BEHAVIOR PER GROUP
    $(document).on("click", ".select-btn", function () {
        var btn = $(this);
        var itemId = btn.data("itemid");
        var groupDiv = btn.closest(".accordion-item"); // گروه فعلی

        // اگر این آیتم فعال است، غیر فعالش کن و به سرور ارسال کن
        if (btn.hasClass("active")) {
            btn.removeClass("active");
            $.post('@Url.Action("ToggleCartItem","Booking")', { itemId: itemId });
            return;
        }

        // غیرفعال کردن بقیه آیتم‌ها در همان گروه
        groupDiv.find(".select-btn.active").removeClass("active");

        // فعال کردن آیتم انتخاب شده
        btn.addClass("active");

        // ارسال به سرور
        $.post('@Url.Action("ToggleCartItem","Booking")', { itemId: itemId });
    });
</script>
}
