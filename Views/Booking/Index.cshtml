@model BlueDream.Models.ViewModels.BookingViewModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor



<div class="container my-5">
    <form id="bookingForm" method="post" asp-action="Calendar">
        <div class="accordion" id="categoryAccordion">
            @{ int categoryDelay = 0;}
            @foreach (var category in Model.Categories)
            {
                categoryDelay++;
                var catId = $"cat_{category.Id}";
                <div class="accordion-item border-0 mb-4 category-animated" style="--delay:@(categoryDelay * 0.1)s">
                    <h2 class="accordion-header" id="heading_@catId">
                        <button class="accordion-button collapsed category-header"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapse_@catId"
                                aria-expanded="false"
                                aria-controls="collapse_@catId">
                            @category.Name
                        </button>
                    </h2>

                    <div id="collapse_@catId"
                         class="accordion-collapse collapse"
                         aria-labelledby="heading_@catId"
                         data-bs-parent="#categoryAccordion">
                        <div class="accordion-body">
                            <div class="accordion" id="groupAccordion_@catId">
                                
                                @{ int groupDelay = 0; }
                                @foreach (var group in category.ItemGroups)
                                {
                                    var groupId = $"grp_{group.Id}";
                                    groupDelay++;
                                    <div class="accordion-item border-0 mb-4 group-animated" style="--delay:@(groupDelay * 0.07)s">
                                        <h2 class="accordion-header" id="heading_@groupId">
                                            <button class="accordion-button collapsed bg-white group-header"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#collapse_@groupId"
                                                    aria-expanded="false"
                                                    aria-controls="collapse_@groupId">
                                                <div>
                                                    <div class="group-title">@group.Name</div>
                                                    <div class="show-details" onclick="openDetails('@group.Name','@group.Description')">Show Details</div>
                                                </div>
                                            </button>
                                        </h2>

                                        <div id="collapse_@groupId"
                                             class="accordion-collapse collapse"
                                             aria-labelledby="heading_@groupId"
                                             data-bs-parent="#groupAccordion_@catId">
                                            <div class="accordion-body">
                                                @if (group.Items?.Any() == true)
                                                {
                                                    <ul class="list-group list-group-flush">
                                                        @{ int itemDelay = 0; }
                                                        @foreach (var item in group.Items)
                                                        {
                                                            
                                                            itemDelay++;
                                                            <li class="list-group-item item-animated" style="--delay:@(itemDelay * 0.05)s">
                                                                <div>
                                                                    <div class="item-name">@item.Name</div>
                                                                    @if (!string.IsNullOrEmpty(item.Description))
                                                                    {
                                                                        <div class="item-description">@item.Description</div>
                                                                    }
                                                                    <div class="item-time">⏱ @item.TimeSpend min</div>
                                                                </div>
                                                                <div class="text-end">
                                                                    <div class="item-price">
                                                                        @if (item.Discount > 0)
                                                                        {
                                                                            <span class="text-decoration-line-through text-muted me-2">€@item.Price</span>
                                                                            <span class="fw-bold text-success">€@(item.Price - (item.Price * item.Discount / 100))</span>
                                                                        }
                                                                        else
                                                                        {

                                                                            <span class="fw-bold">€@item.Price</span>
                                                                        }
                                                                    </div>
                                                                    <button type="button"
                                                                            class="select-btn mt-2 @(HttpContextAccessor.HttpContext.Session.GetString("SelectedItems")?.Split(',').Contains(item.Id.ToString()) == true ? "active" : "")"
                                                                            data-itemid="@item.Id"
                                                                            data-groupid="@group.Id">

                                                                        @(HttpContextAccessor.HttpContext.Session.GetString("SelectedItems")?.Split(',').Contains(item.Id.ToString()) == true ? "Selected" : "Select")

                                                                    </button>
                                                                </div>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else
                                                {
                                                    <p class="text-muted fst-italic">No items in this group.</p>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-next btn-lg px-5">Next →</button>
        </div>
    </form>
</div>

<!-- MODAL DETAILS -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background:#F6F1EB; border-radius:14px;">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="detailsTitle" style="color:#1A2A6C;"></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsText" style="font-size:1rem; color:#444;"></div>
        </div>
    </div>
</div>

<!-- MODAL LOGIN -->
<div class="modal fade" id="loginPromptModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Login Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Please login first to select an item.</p>
                <a href="/Account/Login?returnUrl=@Url.Action("Index", "Booking")" class="btn btn-primary w-100">Go to Login</a>
            </div>
        </div>
    </div>
</div>

<style>
    /* ============================================================
       CATEGORY ANIMATION
       ============================================================ */
    .category-animated {
        opacity: 0;
        transform: translateY(18px);
        animation: fadeMoveUp 0.6s ease forwards;
    }

    @@keyframes fadeMoveUp {
        0% {
            opacity: 0;
            transform: translateY(18px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ============================================================
       GROUP ANIMATION
       ============================================================ */
    .group-animated {
        opacity: 0;
        transform: translateY(14px);
        animation: fadeMoveSm 0.45s ease forwards;
    }

    @@keyframes fadeMoveSm {
        0% {
            opacity: 0;
            transform: translateY(14px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ============================================================
       ITEM ANIMATION
       ============================================================ */
    .item-animated {
        opacity: 0;
        transform: translateY(10px);
        animation: fadeList 0.35s ease forwards;
    }

    @@keyframes fadeList {
        0% {
            opacity: 0;
            transform: translateY(10px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ============================================================
       CATEGORY HEADER (LUXURY STYLE)
       ============================================================ */
    .category-header {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1A2A6C !important;
        background: linear-gradient(135deg, #ffffff, #f6f8ff);
        border-radius: 12px !important;
        padding: 14px 18px;
        transition: 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .category-header:hover {
        background: #f0f3ff;
        box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }

    /* ============================================================
       GROUP HEADER
       ============================================================ */
    .group-header {
        background: white !important;
        border-radius: 10px;
        padding: 14px;
        transition: 0.3s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }

    .group-header:hover {
        background: #fdfbf7 !important;
        box-shadow: 0 6px 12px rgba(0,0,0,0.06);
    }

    .group-title {
        font-size: 1.15rem;
        font-weight: 600;
        color: #1A2A6C;
    }

    .show-details {
        font-size: 0.85rem;
        color: #7a6d58;
        cursor: pointer;
        text-decoration: underline;
        opacity: 0.8;
        transition: opacity 0.2s, color 0.2s;
    }

    .show-details:hover {
        opacity: 1;
        color: #1A2A6C;
    }

    /* ============================================================
       ITEMS
       ============================================================ */
    .list-group-item {
        background: #ffffff;
        border: 0;
        padding: 16px;
        border-radius: 10px !important;
        margin-bottom: 10px;
        transition: 0.25s ease;
        box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }

    .list-group-item:hover {
        background: #f8f8ff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.07);
    }

    .item-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1A2A6C;
    }

    .item-description {
        font-size: 0.9rem;
        color: #555;
    }

    .item-time {
        font-size: 0.85rem;
        color: #6a6a7a;
        margin-top: 3px;
    }

    .item-price {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 5px;
    }

    /* ============================================================
       SELECT BUTTON
       ============================================================ */
    .select-btn {
        border: 1px solid #1A2A6C;
        padding: 6px 16px;
        border-radius: 8px;
        font-size: 0.95rem;
        cursor: pointer;
        font-weight: 600;
        transition: 0.3s;
        background: #ffffff;
        color: #1A2A6C;
    }

    .select-btn.active,
    .select-btn:hover {
        background: #E6BE8A;
        color: #1A2A6C;
        border-color: #E6BE8A;
    }

    /* ============================================================
       NEXT BUTTON
       ============================================================ */
    .btn-next {
        background-color: #1A2A6C;
        color: #fff;
        font-size: 1.1rem;
        font-weight: 600;
        transition: 0.2s ease;
    }

    .btn-next:hover {
        background-color: #E6BE8A;
        color: #1A2A6C;
    }

</style>
@section Scripts {
<script>
    function openDetails(title, text) {
        $("#detailsTitle").text(title);
        $("#detailsText").text(text);
        new bootstrap.Modal(document.getElementById('detailsModal')).show();
    }

    $(document).ready(function () {

        // ---------- MiniCart Update ----------
        function updateMiniCart() {
            $.getJSON('@Url.Action("GetCartItems", "Booking")', function (data) {
                var badge = $('#cartDropdown .badge-cart');
                var dropdown = $('#cartDropdown + .dropdown-menu');
                dropdown.empty();
                if (data.itemCount > 0) {
                    badge.text(data.itemCount).show();
                    $.each(data.items, function (i, item) {
                        dropdown.append('<li class="cart-item d-flex justify-content-between align-items-center px-2 py-1" data-itemid="' + item.id + '">' +
                            '<span>' + item.name + '</span>' +
                            '<span>€' + parseFloat(item.price).toFixed(2) + '</span></li>');
                    });
                    dropdown.append('<li><hr class="dropdown-divider"/></li>');
                    dropdown.append('<li class="px-2"><strong>Total: €' + parseFloat(data.total).toFixed(2) + '</strong></li>');
                    dropdown.append('<li class="px-2 mt-2"><a class="btn btn-primary w-100" href="@Url.Action("Calendar", "Booking")">Go to Checkout</a></li>');
                } else {
                    badge.hide();
                    dropdown.append('<li class="px-2 text-muted">Your cart is empty</li>');
                }

                // بعد از آپدیت سبد، کلاس active دکمه‌ها رو هم هماهنگ کن
        var ids = data.items.map(i => i.id);

        $(".select-btn").each(function () {
            var btn = $(this);
            var itemId = btn.data("itemid");

            var active = ids.includes(itemId);

            btn.toggleClass("active", active);
            btn.text(active ? "Selected" : "Select");
        });

            });
        }

        // ---------- Select Button Logic ----------
        $(document).on("click", ".select-btn", function () {
            var btn = $(this);
            var itemId = btn.data("itemid");
            var groupId = btn.data("groupid");

            var isAuthenticated = @User.Identity.IsAuthenticated.ToString().ToLower();
            if (!isAuthenticated) {
                new bootstrap.Modal(document.getElementById('loginPromptModal')).show();
                return;
            }

            // Radio-like toggle: همه دکمه‌های گروه رو غیرفعال کن
            $('.select-btn[data-groupid="' + groupId + '"]').removeClass('active');

            // درخواست به سرور برای اضافه/حذف از سبد
            $.post('@Url.Action("ToggleCartItem", "Booking")', { itemId: itemId }, function () {
                // آپدیت سبد و همزمان کلاس دکمه‌ها
                updateMiniCart();
            });
        });

        // ---------- Next Button Validation ----------
        $("#bookingForm").on("submit", function(e){
            var selected = $(".select-btn.active").length;
            if(selected === 0){
                e.preventDefault();
                alert("Please select at least one item before proceeding.");
            }
        });

        // بار اول که صفحه لود میشه
        updateMiniCart();
    });
</script>
}
