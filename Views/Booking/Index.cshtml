@model BlueDream.Models.ViewModels.BookingViewModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
ViewData["Title"] = "Book Your Service";
}

<div class="container my-5">
    <h2 class="fw-bold mb-4 text-center text-uppercase">Select Your Service</h2>

    <form id="bookingForm" method="post" asp-action="Calendar">
        <div class="accordion" id="categoryAccordion">
            @foreach(var category in Model.Categories)
            {
            var catId = $"cat_{category.Id}";
            <div class="accordion-item mb-3 border-0 shadow-sm rounded-3">
                <h2 class="accordion-header" id="heading_@catId">
                    <button class="accordion-button collapsed fw-bold bg-navy text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapse_@catId"
                            aria-expanded="false" aria-controls="collapse_@catId">
                        @category.Name
                    </button>
                </h2>

                <div id="collapse_@catId" class="accordion-collapse collapse"
                     aria-labelledby="heading_@catId" data-bs-parent="#categoryAccordion">
                    <div class="accordion-body bg-light">
                        <div class="accordion" id="groupAccordion_@catId">
                            @foreach(var group in category.ItemGroups)
                            {
                            var groupId = $"grp_{group.Id}";
                            <div class="accordion-item mb-2 border-0 rounded-3 shadow-sm">
                                <h2 class="accordion-header" id="heading_@groupId">
                                    <button class="accordion-button collapsed fw-semibold bg-white text-dark"
                                            type="button" data-bs-toggle="collapse"
                                            data-bs-target="#collapse_@groupId"
                                            aria-expanded="false" aria-controls="collapse_@groupId">
                                        <div>
                                            <div>@group.Name</div>
                                            <small class="text-muted">@group.Description</small>
                                        </div>
                                    </button>
                                </h2>

                                <div id="collapse_@groupId" class="accordion-collapse collapse"
                                     aria-labelledby="heading_@groupId"
                                     data-bs-parent="#groupAccordion_@catId">
                                    <div class="accordion-body">
                                        @if(group.Items != null && group.Items.Any())
                                        {
                                        <ul class="list-group list-group-flush">
                                            @foreach(var item in group.Items)
                                            {
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="fw-semibold">@item.Name</span><br/>
                                                    @if(!string.IsNullOrEmpty(item.Description))
                                                    {
                                                    <small class="text-muted">@item.Description</small><br/>
                                                    }
                                                    <small class="text-muted">⏱ @item.TimeSpend min</small>
                                                </div>
                                                <div class="text-end">
                                                    @if(item.Discount > 0)
                                                    {
                                                    <span class="text-decoration-line-through text-muted me-2">€@item.Price</span>
                                                    <span class="fw-bold text-success">€@(item.Price - (item.Price * item.Discount / 100))</span>
                                                    }
                                                    else
                                                    {
                                                    <span class="fw-bold text-dark">€@item.Price</span>
                                                    }

                                                    <div class="mt-2">
                                                        <input type="checkbox" class="cart-checkbox" data-itemid="@item.Id"
                                                               @(HttpContextAccessor.HttpContext.Session.GetString("SelectedItems")?.Split(',').Contains(item.Id.ToString()) == true ? "checked" : "") />
                                                        <label class="ms-1">Select</label>
                                                    </div>
                                                </div>
                                            </li>
                                            }
                                        </ul>
                                        }
                                        else
                                        {
                                        <p class="text-muted fst-italic">No items available in this group.</p>
                                        }
                                    </div>
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
            }
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Next →</button>
        </div>
    </form>
</div>

@section Scripts{
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    function updateMiniCart(){
        $.getJSON('@Url.Action("GetCartItems","Booking")', function(data){
            var badge = $('#cartDropdown .badge-cart');
            var dropdown = $('#cartDropdown + .dropdown-menu');
            dropdown.empty();

            if(data.itemCount > 0){
                badge.text(data.itemCount).show();
                $.each(data.items, function(i,item){
                    dropdown.append('<li class="cart-item d-flex justify-content-between align-items-center px-2 py-1" data-itemid="'+item.Id+'">'+
                        '<span>'+item.Name+'</span>'+
                        '<span>€'+item.Price.toFixed(2)+'</span></li>');
                });
                dropdown.append('<li><hr class="dropdown-divider"/></li>');
                dropdown.append('<li class="px-2"><strong>Total: €'+data.total.toFixed(2)+'</strong></li>');
                dropdown.append('<li class="px-2 mt-2"><a class="btn btn-primary w-100" href="@Url.Action("Calendar","Booking")">Go to Checkout</a></li>');
            } else {
                badge.hide();
                dropdown.append('<li class="px-2 text-muted">Your cart is empty</li>');
            }
        });
    }

    $(document).ready(function(){
        updateMiniCart();

        $('.cart-checkbox').on('change', function(){
            var itemId = $(this).data('itemid');
            $.post('@Url.Action("ToggleCartItem","Booking")', { itemId: itemId }, function(){
                updateMiniCart();
            });
        });

        $('#bookingForm').on('submit', function(e){
            const isLoggedIn = '@User.Identity.IsAuthenticated'.toLowerCase() === 'true';
            if(!isLoggedIn){
                e.preventDefault();
                Swal.fire({
                    title: 'Login required',
                    text: 'Please log in to continue your booking.',
                    icon: 'info',
                    confirmButtonText: 'Go to login',
                    confirmButtonColor: '#002b5b'
                }).then(() => {
                    window.location.href='@Url.Action("Login","Account", new { returnUrl = Url.Action("Index","Booking") })';
                });
            }
        });
    });
</script>
}
