@model BlueDream.Models.ViewModels.BookingViewModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<div class="container my-5">
    <form id="bookingForm" method="post" asp-action="Calendar">
        <div class="accordion" id="categoryAccordion">
            @foreach (var category in Model.Categories)
            {
                var catId = $"cat_{category.Id}";
                <div class="accordion-item border-0 mb-4">
                    <h2 class="accordion-header" id="heading_@catId">
                        <button class="accordion-button collapsed category-header"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapse_@catId"
                                aria-expanded="false"
                                aria-controls="collapse_@catId">
                            @category.Name
                        </button>
                    </h2>

                    <div id="collapse_@catId"
                         class="accordion-collapse collapse"
                         aria-labelledby="heading_@catId"
                         data-bs-parent="#categoryAccordion">
                        <div class="accordion-body">
                            <div class="accordion" id="groupAccordion_@catId">
                                @foreach (var group in category.ItemGroups)
                                {
                                    var groupId = $"grp_{group.Id}";
                                    <div class="accordion-item border-0 mb-3 shadow-sm">
                                        <h2 class="accordion-header" id="heading_@groupId">
                                            <button class="accordion-button collapsed bg-white"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#collapse_@groupId"
                                                    aria-expanded="false"
                                                    aria-controls="collapse_@groupId">
                                                <div>
                                                    <div class="group-title">@group.Name</div>
                                                    <span class="show-details" onclick="openDetails('@group.Name','@group.Description')">Show Details</span>
                                                </div>
                                            </button>
                                        </h2>

                                        <div id="collapse_@groupId"
                                             class="accordion-collapse collapse"
                                             aria-labelledby="heading_@groupId"
                                             data-bs-parent="#groupAccordion_@catId">
                                            <div class="accordion-body">
                                                @if (group.Items?.Any() == true)
                                                {
                                                    <ul class="list-group list-group-flush">
                                                        @foreach (var item in group.Items)
                                                        {
                                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <div class="item-name">@item.Name</div>
                                                                    @if (!string.IsNullOrEmpty(item.Description))
                                                                    { <div class="item-description">@item.Description</div> }
                                                                    <div class="item-time">⏱ @item.TimeSpend min</div>
                                                                </div>
                                                                <div class="text-end">
                                                                    <div class="item-price">
                                                                        @if(item.Discount > 0)
                                                                        {
                                                                            <span class="text-decoration-line-through text-muted me-2">€@item.Price</span>
                                                                            <span class="fw-bold text-success">€@(item.Price - (item.Price * item.Discount / 100))</span>
                                                                        }
                                                                        else { @( "€" + item.Price ) }
                                                                    </div>
                                                                    <button type="button"
                                                                            class="select-btn mt-2 @(HttpContextAccessor.HttpContext.Session.GetString("SelectedItems")?.Split(',').Contains(item.Id.ToString()) == true ? "active" : "")"
                                                                            data-itemid="@item.Id">
                                                                        Select
                                                                    </button>
                                                                </div>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else { <p class="text-muted fst-italic">No items in this group.</p> }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-next btn-lg px-5">Next →</button>
        </div>
    </form>
</div>

<!-- MODAL DETAILS -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background:#F6F1EB; border-radius:14px;">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="detailsTitle" style="color:#1A2A6C;"></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsText" style="font-size:1rem; color:#444;"></div>
        </div>
    </div>
</div>

@section Scripts {
<script>
function openDetails(title, text) {
    $("#detailsTitle").text(title);
    $("#detailsText").text(text);
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

$(document).ready(function () {

    // ---------------- MiniCart Update ----------------
    function updateMiniCart() {
        $.getJSON('@Url.Action("GetCartItems","Booking")', function (data) {
            var badge = $('#cartDropdown .badge-cart');
            var dropdown = $('#cartDropdown + .dropdown-menu');
            dropdown.empty();

            if (data.itemCount > 0) {
                badge.text(data.itemCount).show();
                $.each(data.items, function (i, item) {
                    dropdown.append('<li class="cart-item d-flex justify-content-between align-items-center px-2 py-1" data-itemid="' + item.Id + '">' +
                        '<span>' + item.Name + '</span>' +
                        '<span>€' + (parseFloat(item.Price)).toFixed(2) + '</span></li>');
                });
                dropdown.append('<li><hr class="dropdown-divider"/></li>');
                dropdown.append('<li class="px-2"><strong>Total: €' + (parseFloat(data.total)).toFixed(2) + '</strong></li>');
                dropdown.append('<li class="px-2 mt-2"><a class="btn btn-primary w-100" href="@Url.Action("Calendar","Booking")">Go to Checkout</a></li>');
            } else {
                badge.hide();
                dropdown.append('<li class="px-2 text-muted">Your cart is empty</li>');
            }
        });
    }

    // ---------------- Select Button ----------------
    $(document).on("click", ".select-btn", function () {
        var btn = $(this);
        var itemId = btn.data("itemid");
        var groupDiv = btn.closest(".accordion-item");

        // ---------- Check if user is logged in ----------
        var isAuthenticated = @User.Identity.IsAuthenticated.ToString().ToLower();

        if (!isAuthenticated) {
            // ---------------- Show Login Modal ----------------
            var loginModalHtml = `
            <div class="modal fade" id="loginPromptModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Login Required</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Please login first to select an item.</p>
                            <a href="/Account/Login?returnUrl=@Url.Action("Index","Booking")" class="btn btn-primary w-100">Go to Login</a>
                        </div>
                    </div>
                </div>
            </div>`;

            if ($("#loginPromptModal").length === 0) {
                $("body").append(loginModalHtml);
            }

            new bootstrap.Modal(document.getElementById('loginPromptModal')).show();
            return; // ادامه اجرا نشود
        }

        // ---------------- Logged In User Logic ----------------
        if (!btn.hasClass("active")) {
            groupDiv.find(".select-btn.active").removeClass("active");
            btn.addClass("active");
        } else {
            btn.removeClass("active");
        }

        $.post('@Url.Action("ToggleCartItem","Booking")', { itemId: itemId }, function () {
            updateMiniCart();
        });
    });

    // MiniCart initial load
    updateMiniCart();
});
</script>
}
