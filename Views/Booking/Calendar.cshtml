@model BlueDream.Models.ViewModels.SubmitBookingViewModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Select Date & Time";
}

<div class="container my-5">
    <h2 class="mb-4">Select Date & Time for Your Booking</h2>

    <form asp-action="Submit" method="post" id="calendarForm">
        <input type="hidden" name="selectedTime" id="selectedTime" value="" />

        <div class="mb-4">
            <label for="datepicker" class="form-label fw-bold">Pick a Date:</label>
            <input type="text" id="datepicker" class="form-control" placeholder="Select a date" autocomplete="off" required />
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold">Select a Time Slot:</label>
            <div id="timeSlots" class="d-flex flex-wrap gap-2 mb-2"></div>
            <div id="timeWarning" class="text-danger fw-bold"></div>
        </div>

        <div class="mb-4">
            <h4>Selected Items:</h4>
            <ul class="list-group">
                @foreach(var item in Model.SelectedItems)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>@item.Name (@item.TimeSpend min)</span>
                        <span>€@(item.Discount > 0 ? item.Price - (item.Price * item.Discount / 100) : item.Price)</span>
                    </li>
                }
            </ul>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5">Next →</button>
        </div>
    </form>
</div>

@section Scripts {
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
const timeSlotsContainer = document.getElementById("timeSlots");
const warningContainer = document.getElementById("timeWarning");

flatpickr("#datepicker", {
    dateFormat: "Y-m-d",
    minDate: "today",
    onChange: (selectedDates, dateStr) => {
        if(dateStr) loadTimeSlots(dateStr);
    }
    });

async function loadTimeSlots(dateStr) {
    timeSlotsContainer.innerHTML = "";
    warningContainer.innerText = "";

    try {
        const response = await fetch(`/Booking/GetAvailableTimeSlots?date=${dateStr}`);
        const data = await response.json();

        const slots = data.slots; // working slots
        const booked = data.booked; // booked ranges
        const totalTimeRequired = data.totalTimeRequired; // selected items total time in minutes

        // map booked slots to show only the first slot and remove subsequent
        const bookedMap = {};
        booked.forEach(b => {
            let start = parseTime(b.start);
            let end = parseTime(b.end);
            bookedMap[start] = { start, end, label: b.start + " (Booked)" };
        });

        slots.forEach(slot => {
            let slotStart = parseTime(slot.start);
            let slotEnd = parseTime(slot.end);

            for(let t = slotStart; t + 15 <= slotEnd; t += 15) {
                // if this slot is the first of a booked range, show as booked
                if(bookedMap[t]) {
                    let btn = document.createElement("button");
                    btn.type = "button";
                    btn.classList.add("btn","btn-dark","mb-2");
                    btn.textContent = bookedMap[t].label;
                    btn.disabled = true;
                    timeSlotsContainer.appendChild(btn);
                    // skip all subsequent slots inside this booked range
                    t = bookedMap[t].end - 15;
                    continue;
                }

                let tEnd = t + totalTimeRequired;
                let isOverlap = booked.some(b => {
                    let bStart = parseTime(b.start);
                    let bEnd = parseTime(b.end);
                    return t < bEnd && tEnd > bStart;
                });

                let btn = document.createElement("button");
                btn.type = "button";
                btn.classList.add("btn","mb-2");

                let hour = Math.floor(t / 60).toString().padStart(2,"0");
                let min = (t % 60).toString().padStart(2,"0");
                let timeStr = `${hour}:${min}`;

                if(isOverlap) {
                    btn.classList.add("btn-secondary");
                    btn.textContent = timeStr;
                    btn.title = "Selected items exceed available time";
                    btn.onclick = () => alert("Selected items exceed available time for this slot.");
                } else {
                    btn.classList.add("btn-outline-primary");
                    btn.textContent = timeStr;
                    btn.title = "Available";
                    btn.onclick = () => selectTime(btn, dateStr, timeStr);
                }

                timeSlotsContainer.appendChild(btn);
            }
        });

    } catch(err) {
        console.error("Failed to load time slots:", err);
    }
}

function selectTime(button, dateStr, timeStr) {
    document.querySelectorAll("#timeSlots .btn").forEach(b => b.classList.remove("active"));
    button.classList.add("active");
    document.getElementById("selectedTime").value = `${dateStr} ${timeStr}`;
}

function parseTime(timeStr) {
    let [h,m] = timeStr.split(":").map(Number);
    return h*60 + m;
}
</script>

<style>
#timeSlots .btn {
    min-width: 65px;
    margin-right: 6px;
    margin-bottom: 6px;
    font-weight: 500;
    font-size: 0.9rem;
}
#timeSlots .btn.active {
    border: 2px solid #1A2A6C !important;
}
.btn-dark {
    background-color: #1A2A6C;
    color: white;
}
.btn-secondary {
    background-color: #6c757d;
    color: white;
}
.btn-outline-primary {
    border: 1px solid rgba(19, 16, 87, 0.73);
    color: rgba(19, 16, 87, 0.73);
    background-color: transparent;
}

/* Mobile responsive */
@@media (max-width: 576px) {
    #timeSlots .btn {
        flex: 1 1 40%;
        font-size: 0.85rem;
        min-width: 0;
    }
    }
</style>
}
