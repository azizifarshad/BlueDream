@model BlueDream.Models.ViewModels.SubmitBookingViewModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Select Date & Time";
}

<div class="container my-5">
    <h2 class="mb-4">Select Date & Time for Your Booking</h2>

    <form asp-action="Submit" method="post" id="calendarForm">
        <input type="hidden" name="selectedTime" id="selectedTime" value="" />

        <div class="mb-4">
            <label for="datepicker" class="form-label fw-bold">Pick a Date:</label>
            <input type="text" id="datepicker" class="form-control" placeholder="Select a date" autocomplete="off" required />
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold">Select a Time Slot:</label>
            <div id="timeSlots" class="d-flex flex-wrap gap-2">
            <div id="timeWarning" class="mb-2"></div>
    
                <!-- Time slots will be appended here by JS -->
            </div>
        </div>

        <div class="mb-4">
            <h4>Selected Items:</h4>
            <ul class="list-group">
                @foreach(var item in Model.SelectedItems)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>@item.Name (@item.TimeSpend min)</span>
                        <span>€@(item.Discount > 0 ? item.Price - (item.Price * item.Discount / 100) : item.Price)</span>
                    </li>
                }
            </ul>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5">Next →</button>
        </div>
    </form>
</div>

@section Scripts {
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    var timeSlotsContainer = document.getElementById("timeSlots");

    flatpickr("#datepicker", {
        dateFormat: "Y-m-d",
        minDate: "today",
        onChange: function(selectedDates, dateStr) {
            if (dateStr) {
                loadTimeSlots(dateStr);
            }
        }
    });

    async function loadTimeSlots(dateStr) {
        timeSlotsContainer.innerHTML = "";
        const warningContainer = document.getElementById("timeWarning");
        if(warningContainer) warningContainer.innerText = "";

        try {
            const response = await fetch(`/Booking/GetAvailableTimeSlots?date=${dateStr}`);
            const data = await response.json();

            const slots = data.slots;
            const booked = data.booked;
            const totalTimeRequired = data.totalTimeRequired; // دقیقه

            let hasUnavailable = false; // برای بررسی اینکه حداقل یک گزینه غیر قابل انتخاب است

            slots.forEach(slot => {
                let startParts = slot.start.split(":");
                let endParts = slot.end.split(":");

                let startTime = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
                let endTime = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);

                for (let t = startTime; t + totalTimeRequired <= endTime; t += 15) {
                    let hour = Math.floor(t / 60).toString().padStart(2, "0");
                    let min = (t % 60).toString().padStart(2, "0");
                    let timeStr = `${hour}:${min}`;

                    let btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "btn btn-outline-primary mb-2";

                    // بررسی تداخل با رزروهای قبلی
                    let isBooked = booked.some(b => {
                        let bStartParts = b.start.split(":");
                        let bEndParts = b.end.split(":");
                        let bStart = parseInt(bStartParts[0]) * 60 + parseInt(bStartParts[1]);
                        let bEnd = parseInt(bEndParts[0]) * 60 + parseInt(bEndParts[1]);
                        let tEnd = t + totalTimeRequired;
                        return (t < bEnd && tEnd > bStart);
                    });

                    if (isBooked) {
                        btn.classList.add("disabled");
                        btn.textContent = timeStr + " (Booked)";
                        hasUnavailable = true;
                    } else {
                        btn.textContent = timeStr;
                        btn.onclick = function() {
                            document.querySelectorAll("#timeSlots .btn").forEach(b => b.classList.remove("active"));
                            btn.classList.add("active");
                            document.getElementById("selectedTime").value = dateStr + " " + timeStr;
                        }
                    }

                    timeSlotsContainer.appendChild(btn);
                }
            });

            if(hasUnavailable && warningContainer) {
                warningContainer.innerText = `برخی ساعت‌ها به دلیل طول کل رزرو آیتم‌ها (${Math.floor(totalTimeRequired/60)} ساعت و ${totalTimeRequired % 60} دقیقه) قابل انتخاب نیستند.`;
                warningContainer.style.color = "red";
                warningContainer.style.marginBottom = "10px";
            }

        } catch (err) {
            console.error("Failed to load time slots:", err);
        }
}

</script>

<style>
#timeSlots .btn {
    min-width: 80px;
    margin-right: 8px;
}
#timeSlots .btn.active {
    background-color: #1A2A6C;
    color: #fff;
}
#timeSlots .btn.disabled {
    background-color: #e0e0e0;
    color: #888;
    pointer-events: none;
}
</style>
}
