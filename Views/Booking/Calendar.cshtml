@model BlueDream.Models.ViewModels.SubmitBookingViewModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Select Date & Time";
}

<div class="container my-5">
    <h2 class="mb-4">Select Date & Time for Your Booking</h2>

    <form asp-action="Submit" method="post" id="calendarForm">
        <input type="hidden" name="selectedTime" id="selectedTime" value="" />

        <div class="mb-4">
            <label for="datepicker" class="form-label fw-bold">Pick a Date:</label>
            <input type="text" id="datepicker" class="form-control" placeholder="Select a date" autocomplete="off" required />
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold">Select a Time Slot:</label>
            <div id="timeSlots" class="d-flex flex-wrap gap-2">
                <!-- Time slots will be appended here by JS -->
            </div>
        </div>

        <div class="mb-4">
            <h4>Selected Items:</h4>
            <ul class="list-group">
                @foreach(var item in Model.SelectedItems)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>@item.Name (@item.TimeSpend min)</span>
                        <span>€@(item.Discount > 0 ? item.Price - (item.Price * item.Discount / 100) : item.Price)</span>
                    </li>
                }
            </ul>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5">Next →</button>
        </div>
    </form>
</div>

@section Scripts {
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    var timeSlotsContainer = document.getElementById("timeSlots");

    flatpickr("#datepicker", {
        dateFormat: "Y-m-d",
        minDate: "today",
        onChange: function(selectedDates, dateStr) {
            if (dateStr) {
                loadTimeSlots(dateStr);
            }
        }
    });

    async function loadTimeSlots(dateStr) {
        timeSlotsContainer.innerHTML = "";

        try {
            const response = await fetch(`/Booking/GetAvailableTimeSlots?date=${dateStr}`);
            const data = await response.json();

            const slots = data.slots;
            const booked = data.booked.map(b => b.start); // فقط ساعت شروع رزرو شده

            slots.forEach(slot => {
                let startHour = parseInt(slot.start.split(":")[0]);
                let endHour = parseInt(slot.end.split(":")[0]);

                for (let h = startHour; h < endHour; h++) {
                    let timeStr = h.toString().padStart(2, "0") + ":00";

                    let btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "btn btn-outline-primary mb-2";

                    if (booked.includes(timeStr)) {
                        btn.classList.add("disabled");
                        btn.textContent = timeStr + " (Booked)";
                    } else {
                        btn.textContent = timeStr;
                        btn.onclick = function() {
                            document.querySelectorAll("#timeSlots .btn").forEach(b => b.classList.remove("active"));
                            btn.classList.add("active");
                            document.getElementById("selectedTime").value = dateStr + " " + timeStr;
                        }
                    }

                    timeSlotsContainer.appendChild(btn);
                }
            });

        } catch (err) {
            console.error("Failed to load time slots:", err);
        }
    }
</script>

<style>
#timeSlots .btn {
    min-width: 80px;
    margin-right: 8px;
}
#timeSlots .btn.active {
    background-color: #1A2A6C;
    color: #fff;
}
#timeSlots .btn.disabled {
    background-color: #e0e0e0;
    color: #888;
    pointer-events: none;
}
</style>
}
