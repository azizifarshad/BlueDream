@model IEnumerable<BlueDream.Models.Entities.Cart>
@using BlueDream.Models.Entities


@{
    ViewData["Title"] = "Manage Carts";
}

<h2 class="mb-4">Manage Carts</h2>


<table class="table table-striped table-bordered align-middle">
    <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>User</th>
            <th>Date</th>
            <th>Items</th>
            <th>Price</th>
            <th>Status</th>
            <th>Operation</th>
        </tr>
    </thead>
    <tbody>
    @foreach (var cart in Model)
    {
        <tr>
            <td>@cart.Id</td>
            <td>@(cart.User?.Name ?? cart.User?.UserName ?? "Unknown")</td>
            <td>@cart.TimeStart.ToString("yyyy/MM/dd HH:mm")</td>
            <td>
                @foreach (var item in cart.Items)
                {
                    <div>
                        <strong>@item.ItemGroup?.Category?.Name</strong> /
                        @item.ItemGroup?.Name / @item.Name
                    </div>
                }
            </td>
            <td>@cart.FinalPrice.ToString("N0") Euro</td>
            <td>
                @switch(cart.Status)
                {
                    case StatusEnum.Created:
                        <span class="badge bg-primary">Created</span>
                        break;
                    case StatusEnum.Requested:
                        <span class="badge bg-info text-dark">Requested</span>
                        break;
                    case StatusEnum.Confirmed:
                        <span class="badge bg-success">Confirmed</span>
                        break;
                    case StatusEnum.Rejected:
                        <span class="badge bg-danger">Rejected</span>
                        break;
                    case StatusEnum.Done:
                        <span class="badge bg-secondary">Done</span>
                        break;
                    case StatusEnum.Canceled:
                        <span class="badge bg-dark">Canceled</span>
                        break;
                }
            </td>
            <td>
                @if(cart.Status == StatusEnum.Created || cart.Status == StatusEnum.Requested)
                {
                    <form asp-action="ChangeStatus" method="post" class="d-inline status-form">    
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@cart.Id" />
                        <input type="hidden" name="newStatus" value="Confirmed" />
                        
                        <button type="submit" class="btn btn-sm btn-success status-btn"
                                data-user="@cart.User?.Name"
                                data-date="@cart.TimeStart.ToString("yyyy/MM/dd HH:mm")"
                                data-status="Confirmed">Accept</button>
                    </form>

                    <form asp-action="ChangeStatus" method="post" class="d-inline status-form">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@cart.Id" />
                        <input type="hidden" name="newStatus" value="Rejected" />
                        <button type="submit" class="btn btn-sm btn-danger status-btn"
                                data-user="@cart.User?.Name"
                                data-date="@cart.TimeStart.ToString("yyyy/MM/dd HH:mm")"
                                data-status="Rejected">Reject</button>
                    </form>
                    
                }
                else if(cart.Status == StatusEnum.Confirmed)
                {
                    <form asp-action="ChangeStatus" method="post" class="d-inline status-form">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@cart.Id" />
                    <input type="hidden" name="newStatus" value="Done" />
                    <button type="submit" class="btn btn-sm btn-secondary status-btn"
                            data-user="@cart.User?.Name"
                            data-date="@cart.TimeStart.ToString("yyyy/MM/dd HH:mm")"
                            data-status="Done">Done</button>
                    </form>
                }
            </td>
        </tr>
    }
    </tbody>
</table>


@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const forms = document.querySelectorAll(".status-form");
            forms.forEach(form => {
                form.addEventListener("submit", function(e){
                    e.preventDefault();
                    const button = form.querySelector("button");
                    const user = button.getAttribute("data-user");
                    const date = button.getAttribute("data-date");
                    const status = button.getAttribute("data-status");

                    Swal.fire({
                        title: 'Are you sure?',
                        text: `Change cart for ${user} on ${date} to ${status}?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: status,
                        confirmButtonColor: status === "Confirmed" ? '#28a745' : status === "Rejected" ? '#dc3545' : '#6c757d'
                    }).then(result => {
                        if(result.isConfirmed){
                            form.submit();
                        }
                    });
                });
            });

            @if (TempData["ToastrMessage"] != null)
            {
                <text>
                    toastr.success('@TempData["ToastrMessage"]');
                </text>
            }
        });
    </script>
}